# Build Scripts for IC256 Sampler

This directory contains scripts and configuration files for building standalone executables and installers.

## Files

- **`build_exe.ps1`** - Enhanced PowerShell script to build Windows executable using PyInstaller
- **`ic256_sampler.spec`** - PyInstaller specification file for reproducible builds
- **`build_for_ic256.iss`** - Inno Setup script for creating Windows installer
- **`logo.ico`** - Application icon used in builds

## Prerequisites

### For Building Executables

1. **Python 3.8+** installed and in PATH

2. **PyInstaller** (will be auto-installed if missing):
   ```powershell
   pip install pyinstaller
   ```
   Or install build dependencies:
   ```powershell
   pip install -e ".[build]"
   ```

3. **Python dependencies** (install from project root):
   ```powershell
   pip install -r requirements.txt
   ```

### For Building Installers

1. **Inno Setup** (Windows only):
   - Download from: https://jrsoftware.org/isinfo.php
   - Install and ensure `iscc.exe` is in your PATH
   - Recommended version: 6.0 or later

## Building Executable

### Quick Build

From the project root:
```powershell
.\scripts\build_exe.ps1
```

The script will:
- Auto-detect version from `pyproject.toml`
- Validate prerequisites (Python, PyInstaller, files)
- Build the executable using the spec file
- Display build statistics

### Build with Options

```powershell
# Clean build (removes previous builds)
.\scripts\build_exe.ps1 -Clean

# Skip validation checks (faster, less safe)
.\scripts\build_exe.ps1 -SkipValidation

# Combine options
.\scripts\build_exe.ps1 -Clean -SkipValidation
```

The executable will be created as `dist/ic256-sampler-{version}.exe` (e.g., `dist/ic256-sampler-1.0.0.exe`).

### Manual Build with PyInstaller

```powershell
cd scripts
pyinstaller --clean ic256_sampler.spec
```

## Automated Builds (GitHub Actions)

The project includes a GitHub Actions workflow (`.github/workflows/build.yml`) that automatically builds Windows executables on:

- **Pushes** to `main` or `develop` branches
- **Pull requests** to `main` or `develop`
- **Version tags** (e.g., `v1.1.0`)
- **Manual trigger** via GitHub Actions UI

### Using GitHub Actions

1. **Automatic builds**: Simply push to `main` or `develop` and the workflow will run automatically
2. **Download artifacts**: 
   - Go to the **Actions** tab in GitHub
   - Select the workflow run
   - Download the artifact named `ic256-sampler-windows-{version}`
3. **Manual trigger**: 
   - Go to **Actions** → **Build Windows Executable** → **Run workflow**

The workflow uses the same build script (`build_exe.ps1`) with `-SkipValidation` flag for faster CI builds.

## Building Installer

1. **First, build the executable** (see above)

2. **Build the installer** with Inno Setup:
   ```powershell
   iscc scripts\build_for_ic256.iss
   ```

   Or open `build_for_ic256.iss` in Inno Setup Compiler and click "Build".

The installer will be created in `dist/IC256-Sampler-Setup-{version}.exe`.

**Note:** The installer script includes a pre-build check to ensure the executable exists.

## Build Process

1. **PyInstaller** bundles the Python application and dependencies into a single executable:
   - Includes all required Python packages
   - Bundles image assets
   - Creates a single-file executable (no external dependencies needed)
   - Configures for Windows GUI (no console window)

2. **Inno Setup** creates a Windows installer that:
   - Installs the executable to Program Files
   - Creates Start Menu shortcuts
   - Creates desktop shortcut (optional)
   - Sets up data directory with proper permissions
   - Handles uninstallation cleanly

## Configuration

### Version Management

**Single Source of Truth**: The version is defined only in `pyproject.toml`.

To update the version:
1. Edit `pyproject.toml` and update the `version` field in `[project]`
2. All other files automatically use this version:
   - `ic256_sampler/__init__.py` reads from package metadata or `pyproject.toml`
   - `build_exe.ps1` reads from `pyproject.toml` and generates `version.iss`
   - `build_for_ic256.iss` includes the generated `version.iss` file

**Note**: The `version.iss` file is automatically generated by `build_exe.ps1`. If building the installer manually without running the build script first, you may need to create this file or define `AppVersion` directly in the Inno Setup script.

### AppId (Application Identifier)

The `AppId` in `build_for_ic256.iss` is a unique GUID that Windows uses to identify your application. This GUID:
- Must be unique for your application
- Should never change once you start distributing the application
- Is used by Windows for uninstallation, updates, and registry entries

**To generate a new GUID:**
```powershell
# PowerShell
[guid]::NewGuid()

# Python
python -c "import uuid; print(str(uuid.uuid4()).upper())"

# Online tools
# https://www.guidgenerator.com/
```

**Important**: Once you start distributing installers, do NOT change the AppId. Changing it will make Windows treat it as a different application, preventing proper upgrades and leaving old installations behind.

### Spec File Customization

The `ic256_sampler.spec` file contains all PyInstaller configuration:

- **`hiddenimports`**: Modules that PyInstaller might miss (e.g., `msgpack`, `PIL`, `websocket`)
- **`datas`**: Data files to include (images are bundled here)
- **`excludes`**: Modules to exclude to reduce size
- **`upx`**: UPX compression (disabled by default - can cause issues)

### Assets

Images are automatically bundled from `ic256_sampler/assets/images/` and placed in `sys._MEIPASS/images/` at runtime. The `ImageLoader` class handles this automatically.

## Troubleshooting

### Build Script Issues

**"Python not found"**
- Ensure Python is installed and in your PATH
- Test with: `python --version`

**"PyInstaller not found"**
- The script will attempt to install it automatically
- Or manually: `pip install pyinstaller`

**"Spec file not found"**
- Ensure you're running from the project root
- Check that `scripts/ic256_sampler.spec` exists

### Executable Issues

**Executable is too large**
- The spec file includes exclusions for common unused modules
- You can add more to the `excludes` list in the spec file
- UPX compression is disabled by default (set `upx=True` in spec if needed)

**"Missing module" errors at runtime**
- Add the missing module to `hiddenimports` in `ic256_sampler.spec`
- Check PyInstaller build logs for warnings
- Test on a clean machine to identify missing dependencies

**Images not loading**
- Images are bundled to `sys._MEIPASS/images/`
- The `ImageLoader` class handles this automatically
- Check that all image files exist in `ic256_sampler/assets/images/`

**Executable crashes on startup**
- Enable console mode temporarily: set `console=True` in spec file
- Check Windows Event Viewer for error details
- Test with: `pyinstaller --debug=all ic256_sampler.spec`

### Installer Issues

**"Executable not found" error**
- Build the executable first using `build-exe.ps1`
- Ensure `dist/ic256-sampler.exe` exists before building installer

**Installer fails to create**
- Check that Inno Setup is installed correctly
- Verify `iscc.exe` is in PATH: `iscc` should run
- Check Inno Setup compiler output for errors

## Best Practices

1. **Always test the executable** on a clean machine before distribution
2. **Version control the spec file** - it ensures reproducible builds
3. **Update version numbers** in `pyproject.toml` (build script reads from here)
4. **Test the installer** on a fresh Windows installation
5. **Use clean builds** (`-Clean` flag) when troubleshooting
6. **Check build output** for warnings about missing modules
7. **Sign the executable** (optional but recommended for distribution)
8. **Test all features** after building to ensure nothing is missing

## Build Output

After a successful build, you'll see:
- Executable path and size
- Build duration
- Next steps (testing, building installer)

Example output:
```
========================================
  Build Successful!
========================================
Executable: C:\...\dist\ic256-sampler-1.0.0.exe
Size: 45.23 MB (46356 KB)
Build time: 12.3 seconds
```

**Note**: The executable is automatically renamed to include the version number (e.g., `ic256-sampler-1.0.0.exe`). The GUI window title will also display the version (e.g., "IC256 Sampler v1.0.0").

## Advanced Usage

### Custom Build Configuration

Edit `ic256_sampler.spec` to customize:
- Compression settings
- Included/excluded modules
- Binary dependencies
- UPX compression

### Debug Builds

For debugging, modify the spec file:
```python
exe = EXE(
    ...
    console=True,  # Show console for debugging
    debug=True,    # Include debug symbols
    ...
)
```

### Distribution Checklist

Before distributing:
- [ ] Test executable on clean Windows machine
- [ ] Verify all images load correctly
- [ ] Test all application features
- [ ] Check file size is reasonable
- [ ] Build installer and test installation
- [ ] Test uninstallation
- [ ] Verify Start Menu shortcuts work
- [ ] Test on Windows 10 and 11 (if applicable)
